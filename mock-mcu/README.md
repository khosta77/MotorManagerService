# MockMCU - Имитатор микроконтроллера

MockMCU - это программа-имитатор микроконтроллера для тестирования протокола взаимодействия с MotorControlService. Она использует реальный модуль FT232RL для связи с основным сервисом.

## Назначение

MockMCU имитирует поведение реального микроконтроллера STM32F407VG, который:
- Принимает команды от MotorControlService через FT232RL
- Обрабатывает команды согласно протоколу из документации
- Отправляет ответы обратно в сервис

## Архитектура

```
MotorControlService (Device 0) ←→ FT232RL ←→ MockMCU (Device 1)
```

- **MotorControlService** работает с устройством FT232RL ID=0
- **MockMCU** работает с устройством FT232RL ID=1
- Оба устройства подключены к одному компьютеру

## Сборка

```bash
cd mock-mcu
mkdir build
cd build
cmake ..
make
```

## Использование

### Базовый запуск
```bash
./mock-mcu
```

### С указанием устройства
```bash
./mock-mcu -d 1
```

### С показом статистики
```bash
./mock-mcu -s
```

### Подробный режим
```bash
./mock-mcu -v
```

## Параметры командной строки

- `-d, --device ID` - ID устройства FT232RL (по умолчанию: 1)
- `-h, --help` - Показать справку
- `-v, --verbose` - Подробный вывод
- `-s, --stats` - Показывать статистику каждые 5 секунд

## Поддерживаемые команды

### 1. Команда версии (0x20)
- **Запрос**: `0x20`
- **Ответ**: `0x12` (версия 1.2)

### 2. Команда движения моторов
- **Синхронный режим**: `0x8N` (N = количество моторов)
- **Асинхронный режим**: `0x4N` (N = количество моторов)

#### Протокол взаимодействия:
1. Отправка команды режима и количества моторов
2. Получение подтверждения готовности MCU (`0x00` = OK)
3. Отправка параметров моторов (16 байт на мотор)
4. Ожидание результата выполнения (`0xFF` = успех)

## Статистика

MockMCU ведет статистику работы:
- Команд получено
- Команд обработано
- Ошибок произошло
- Запросов версии
- Команд моторов

## Тестирование

### 1. Запуск MockMCU
```bash
./mock-mcu -d 1 -s
```

### 2. Запуск MotorControlService
```bash
cd ../build
./source/universal_server
```

### 3. Тестирование через клиент
Отправьте команды через TCP клиент на порт 38000:

```json
{
    "command": "version",
    "message": ""
}
```

```json
{
    "command": "moving",
    "message": "{\"mode\":\"synchronous\",\"motors\":[{\"number\":1,\"acceleration\":2000,\"maxSpeed\":5000,\"step\":100}]}"
}
```

## Логирование

MockMCU выводит подробные логи всех операций:
- Полученные команды
- Отправленные ответы
- Ошибки обработки
- Статистику работы

## Обработка ошибок

MockMCU поддерживает все коды ошибок из документации:
- **Готовность MCU**: 0x01-0x0A
- **Выполнение**: 0x01-0x0F

## Завершение работы

Для корректного завершения нажмите `Ctrl+C`. MockMCU:
1. Остановит обработку команд
2. Отключится от FT232RL
3. Покажет финальную статистику

## Требования

- macOS с поддержкой arm64
- FTDI D2XX драйверы
- Два устройства FT232RL
- Собранный проект MotorControlService
