# MockMCU - Руководство по использованию

## Обзор

MockMCU - это программа-имитатор микроконтроллера STM32F407VG для тестирования протокола взаимодействия с MotorControlService. Она использует реальный модуль FT232RL для связи с основным сервисом.

## Архитектура системы

```
┌─────────────────────┐    FT232RL    ┌─────────────────────┐
│ MotorControlService │ ←────────────→ │      MockMCU        │
│   (Device ID=0)     │    (USB)      │   (Device ID=1)     │
└─────────────────────┘               └─────────────────────┘
```

## Быстрый старт

### 1. Сборка MockMCU
```bash
cd mock-mcu
mkdir build && cd build
cmake ..
make
```

### 2. Запуск MockMCU
```bash
# Базовый запуск
./mock-mcu

# С показом статистики
./mock-mcu -s

# С подробным выводом
./mock-mcu -v

# С указанием устройства
./mock-mcu -d 1
```

### 3. Запуск MotorControlService
```bash
cd ../../build
./source/universal_server
```

## Поддерживаемые команды

### Команда версии (0x20)
- **Запрос**: `0x20`
- **Ответ**: `0x12` (версия 1.2)

### Команда движения моторов
- **Синхронный режим**: `0x8N` (N = количество моторов)
- **Асинхронный режим**: `0x4N` (N = количество моторов)

#### Протокол взаимодействия:
1. Отправка команды режима и количества моторов
2. Получение подтверждения готовности MCU (`0x00` = OK)
3. Отправка параметров моторов (16 байт на мотор)
4. Ожидание результата выполнения (`0xFF` = успех)

## Тестирование через TCP клиент

### 1. Запуск MockMCU
```bash
./mock-mcu -d 1 -s
```

### 2. Запуск MotorControlService
```bash
cd ../../build
./source/universal_server
```

### 3. Тестирование команд

#### Команда версии:
```bash
echo '{"command":"version","message":""}' | nc 127.0.0.1 38000
```

#### Команда движения моторов:
```bash
echo '{"command":"moving","message":"{\"mode\":\"synchronous\",\"motors\":[{\"number\":1,\"acceleration\":2000,\"maxSpeed\":5000,\"step\":100}]}"}' | nc 127.0.0.1 38000
```

## Параметры командной строки

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `-d, --device ID` | ID устройства FT232RL | 1 |
| `-h, --help` | Показать справку | - |
| `-v, --verbose` | Подробный вывод | отключен |
| `-s, --stats` | Показывать статистику каждые 5 секунд | отключен |

## Статистика работы

MockMCU ведет статистику:
- **Команд получено**: Общее количество полученных команд
- **Команд обработано**: Успешно обработанные команды
- **Ошибок произошло**: Количество ошибок
- **Запросов версии**: Количество запросов версии
- **Команд моторов**: Количество команд движения

## Логирование

MockMCU выводит подробные логи:
```
[19:06:45.123] MockMCU: MockMCU initialized on device 1
[19:06:45.124] MockMCU: MockMCU started
[19:06:45.125] MockMCU: Worker thread started
[19:06:46.234] MockMCU: Received command: 0x20
[19:06:46.235] MockMCU: Handling version command
[19:06:46.236] MockMCU: Version response sent: 1.2
```

## Обработка ошибок

MockMCU поддерживает все коды ошибок из документации:

### Коды готовности MCU (0x01-0x0A):
- `0x01`: Некорректное количество моторов
- `0x02`: Некорректный режим работы
- `0x03`: Ошибка инициализации системы
- `0x04`: Недостаточно памяти
- `0x05`: Ошибка конфигурации
- `0x06`: Ошибка драйвера
- `0x07`: Ошибка питания
- `0x08`: Ошибка связи
- `0x09`: Превышение лимитов
- `0x0A`: Общая ошибка системы

### Коды выполнения (0x01-0x0F):
- `0x01`: Ошибка инициализации мотора
- `0x02`: Превышение максимальной скорости
- `0x03`: Ошибка расчета ускорения
- `0x04`: Ошибка позиционирования
- `0x05`: Механическая ошибка (мотор заклинило)
- `0x06`: Перегрев драйвера
- `0x07`: Ошибка питания
- `0x08`: Ошибка связи с драйвером
- `0x09`: Превышение лимитов движения
- `0x0A`: Ошибка калибровки
- `0x0B`: Аварийная остановка
- `0x0C`: Ошибка синхронизации
- `0x0D`: Таймаут выполнения команды
- `0x0E`: Ошибка чтения энкодера
- `0x0F`: Общая ошибка выполнения

## Завершение работы

Для корректного завершения нажмите `Ctrl+C`. MockMCU:
1. Остановит обработку команд
2. Отключится от FT232RL
3. Покажет финальную статистику

## Требования

- macOS с поддержкой arm64
- FTDI D2XX драйверы
- Два устройства FT232RL
- Собранный проект MotorControlService

## Устранение неполадок

### Ошибка подключения к FT232RL
- Убедитесь, что устройство подключено
- Проверьте права доступа к устройству
- Убедитесь, что используется правильный Device ID

### Ошибки сборки
- Убедитесь, что основной проект собран без профилирования
- Проверьте архитектуру (должна быть arm64)
- Убедитесь, что все зависимости установлены

### Проблемы с протоколом
- Проверьте настройки FT232RL (9600 baud, 8N1)
- Убедитесь, что устройства используют разные ID
- Проверьте логи MockMCU для диагностики
